# Decision Log

此文件使用列表格式记录架构和实现决策。
2025-06-14 09:30:00 - 更新日志。

*

## 决策

*

## 理由

*

## 实现细节

*
[2025-06-14 10:19:00] - **MCP 服务器架构决策**
## 决策
创建基于现有 CodeSemanticSearch 的轻量级 MCP 控制台应用程序，仅提供 SemanticCodeSearch 工具，移除 IndexCodebase 工具以简化实现。

## 理由
1. 用户明确表示不需要 IndexCodebase 功能
2. 简化架构降低复杂性和维护成本
3. 专注于核心语义搜索功能
4. 利用现有的 CodeSemanticSearch.cs 实现

## 实现细节
- 使用 Microsoft.Extensions.Hosting 创建控制台主机
- 配置 WithStdioServerTransport() 用于标准输入输出通信
- 单一 SemanticCodeSearch 工具支持自然语言代码搜索
- 通过配置文件管理默认代码库路径和 API 密钥
[2025-06-14 14:51:00] - **MCP 工具用户体验优化决策**

## 决策

优化 MCP 工具的描述和参数说明，提升工具的可用性和用户理解度。

## 理由

1. 原有的工具描述过于简洁，用户难以理解使用场景
2. 参数说明不够详细，特别是路径格式要求不明确
3. 缺少使用提示和示例，影响工具的易用性
4. 需要明确默认行为和参数要求

## 实现细节

- 工具描述增加使用场景提示："当需要查看项目中特定功能或逻辑的代码实现时"
- codebasePath 参数明确默认使用当前工作目录，要求提供完整绝对路径
- query 参数增加更多搜索示例："异常处理机制"、"配置管理"等
- limit 参数明确默认值说明
- 所有描述更加详细和实用
[2025-06-15 07:53:00] - **增量重建索引架构决策**

## 决策

实施基于文件修改时间的增量重建索引功能，避免全量重建造成的资源浪费。

## 理由

1. **性能优化需求**：全量重建对大型代码库耗时过长，用户体验差
2. **资源效率**：避免重复索引未变更文件，节省计算资源和时间
3. **实时性要求**：快速响应文件变更，保持索引的时效性
4. **扩展性考虑**：为未来支持更大规模代码库奠定基础

## 实现细节

* **数据模型扩展**：
  - 在 `CodebaseMapping` 中添加 `FileIndexDetails` 列表
  - 每个文件记录最后索引时间和可选的文件哈希
  - 使用规范化的相对路径确保跨平台一致性

* **增量算法设计**：
  - 文件删除检测：对比 `FileIndexDetails` 与当前物理文件
  - 文件修改检测：比较文件修改时间与最后索引时间
  - 文件新增检测：在 `FileIndexDetails` 中不存在的文件

* **集成策略**：
  - 复用现有的任务管理、连接监控、文件监控系统
  - 保持向后兼容性，不影响现有索引流程
  - 统一的错误处理和状态报告机制

* **技术选择**：
  - 使用 `File.GetLastWriteTimeUtc()` 进行变更检测（暂不实现文件哈希）
  - 基于相对路径的文件标识，支持代码库迁移
  - 异步执行确保UI响应性
[2025-06-15 08:11:00] - **C# Roslyn 解析器架构决策**

## 决策

将现有基于正则表达式的 ExtractCSharpSnippets 方法重构为使用 Microsoft.CodeAnalysis (Roslyn)，同时建立可扩展的解析器抽象架构，但当前只实现 C# 解析器。

## 理由

1. **解析准确性问题**：现有正则表达式方法存在约 15% 的误判率，无法准确处理复杂 C# 语法
2. **维护成本高**：复杂的正则表达式（370-376行）难以维护和调试
3. **扩展性受限**：正则表达式方法难以支持现代 C# 特性和语法糖
4. **用户明确需求**：用户要求抽象化解析逻辑以支持多语言，但其他语言暂不实现

## 实现细节

* **技术选择**：
  - 使用 Microsoft.CodeAnalysis.CSharp 替代正则表达式
  - 设计 ICodeParser 接口为将来扩展预留
  - 实现 CSharpRoslynParser 作为核心解析器
  - 创建 CodeSnippetVisitor 基于语法树访问者模式

* **架构设计**：
  - 保持现有 CodeSnippet 模型不变，确保向后兼容
  - 通过 CodeParserFactory 提供统一的解析器获取入口
  - 错误处理策略：记录错误并跳过，不影响其他文件处理
  - 语言识别基于文件扩展名（.cs）

* **集成策略**：
  - 更新两个项目中的 ExtractCSharpSnippets 方法
  - 保持方法签名兼容性，最小化破坏性变更
  - 集成到现有索引系统和文件监控服务
  - 预期解析准确性从 ~85% 提升到 ~99%

* **实施计划**：
  - 4个阶段，总计约5-6天完成
  - 包含完整的测试验证和性能对比
  - 详细计划已保存为 CSharp-Roslyn-Parser-Upgrade-Plan.md
[2025-06-15 08:38:00] - **多语言代码解析框架架构决策**

## 决策

采用简化的多语言代码解析框架设计，专注于满足索引构建需求，当前实现C#解析器，为将来扩展其他语言预留标准接口。

## 理由

1. **用户明确需求**：用户要求"C#解析器可以简单实现，满足索引构建即可"
2. **避免过度设计**：之前的复杂优化方案超出了实际需求
3. **快速交付**：简化设计可以在3-4天内完成实施
4. **扩展性平衡**：在简单性和扩展性之间找到合适的平衡点
5. **现实可行**：基于现有代码基础，降低实施风险

## 实现细节

* **架构模式**：
  - ICodeParser基础接口定义解析器标准
  - LanguageDetector负责文件类型识别
  - CodeParserFactory统一管理解析器创建
  - SimpleCodeSnippetVisitor简化的语法树访问

* **C#解析器特点**：
  - 基于Roslyn进行准确的语法解析
  - 简化的错误处理，专注核心功能
  - 限制代码片段大小，避免性能问题
  - 支持现代C#语法特性

* **扩展机制**：
  - 标准化的ICodeParser接口
  - 工厂模式支持动态注册新解析器
  - 语言信息模型支持元数据管理
  - 为Python、JavaScript等预留扩展空间

* **集成策略**：
  - 保持与现有索引系统兼容
  - 最小化对现有代码的影响
  - 渐进式替换现有解析逻辑